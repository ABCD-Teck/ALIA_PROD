name: Deploy to Hetzner Production Server

on:
  push:
    branches:
      - master  # æ¨é€åˆ° master åˆ†æ”¯æ—¶è§¦å‘
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸš€ Deploy to Production Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 30m
          script: |
            set -e  # ä»»ä½•å‘½ä»¤å¤±è´¥æ—¶ç«‹å³é€€å‡º

            echo "======================================"
            echo "ğŸš€ å¼€å§‹è‡ªåŠ¨éƒ¨ç½² Alia Web..."
            echo "======================================"

            # è¿›å…¥é¡¹ç›®ç›®å½•
            cd /var/www/alia || { echo "âŒ é¡¹ç›®ç›®å½•ä¸å­˜åœ¨"; exit 1; }

            # æ˜¾ç¤ºå½“å‰çŠ¶æ€
            echo "ğŸ“ å½“å‰ç›®å½•: $(pwd)"
            echo "ğŸŒ¿ å½“å‰åˆ†æ”¯: $(git branch --show-current)"

            # å¤„ç†å¯èƒ½çš„æœ¬åœ°æ›´æ”¹
            echo "ğŸ” æ£€æŸ¥æœ¬åœ°æ›´æ”¹..."
            if ! git diff-index --quiet HEAD --; then
              echo "âš ï¸  æ£€æµ‹åˆ°æœ¬åœ°æ›´æ”¹ï¼Œæš‚å­˜ä¸­..."
              git stash
            fi

            # æ‹‰å–æœ€æ–°ä»£ç 
            echo "â¬‡ï¸  æ‹‰å–æœ€æ–°ä»£ç ..."
            git fetch origin master || { echo "âŒ Git fetch å¤±è´¥"; exit 1; }
            git reset --hard origin/master || { echo "âŒ Git reset å¤±è´¥"; exit 1; }

            # æ¸…ç†æ—§çš„æ„å»ºäº§ç‰©
            echo "ğŸ§¹ æ¸…ç†æ—§çš„æ„å»ºäº§ç‰©..."
            rm -rf build

            # å®‰è£…ä¾èµ–
            echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
            export NODE_ENV=production
            npm ci --include=dev || npm install --production=false || { echo "âŒ npm install å¤±è´¥"; exit 1; }

            # æ„å»ºå‰ç«¯
            echo "ğŸ—ï¸  æ„å»ºå‰ç«¯..."
            export NODE_OPTIONS="--max-old-space-size=4096"
            npm run build || {
              echo "âŒ å‰ç«¯æ„å»ºå¤±è´¥ï¼"
              echo "ğŸ“‹ æ„å»ºæ—¥å¿—å·²è®°å½•"
              exit 1
            }

            # éªŒè¯æ„å»ºäº§ç‰©
            if [ ! -d "build" ]; then
              echo "âŒ æ„å»ºç›®å½•ä¸å­˜åœ¨"
              exit 1
            fi

            if [ -z "$(ls -A build)" ]; then
              echo "âŒ æ„å»ºç›®å½•ä¸ºç©º"
              exit 1
            fi

            echo "âœ… æ„å»ºéªŒè¯é€šè¿‡ - æ„å»ºæ–‡ä»¶æ•°: $(find build -type f | wc -l)"

            # æ£€æŸ¥ PM2 æœåŠ¡çŠ¶æ€
            echo "ğŸ” æ£€æŸ¥ PM2 æœåŠ¡çŠ¶æ€..."
            if pm2 describe alia-server > /dev/null 2>&1; then
              echo "ğŸ”„ é‡å¯åç«¯æœåŠ¡..."
              pm2 restart alia-server || { echo "âŒ PM2 é‡å¯å¤±è´¥"; exit 1; }
            else
              echo "âš ï¸  æœåŠ¡ä¸å­˜åœ¨ï¼Œå°è¯•å¯åŠ¨..."
              pm2 start server/index.js --name alia-server || { echo "âŒ PM2 å¯åŠ¨å¤±è´¥"; exit 1; }
            fi

            # ä¿å­˜ PM2 é…ç½®
            pm2 save

            # æ˜¾ç¤ºçŠ¶æ€
            echo ""
            echo "ğŸ“Š æœåŠ¡çŠ¶æ€ï¼š"
            pm2 status

            echo ""
            echo "======================================"
            echo "âœ… éƒ¨ç½²æˆåŠŸå®Œæˆï¼"
            echo "======================================"
            echo "ğŸŒ è®¿é—®åœ°å€: http://157.180.38.176"
            echo "â° éƒ¨ç½²æ—¶é—´: $(date)"
