name: Deploy to Hetzner Production Server

on:
  push:
    branches:
      - master  # æ¨é€åˆ° master åˆ†æ”¯æ—¶è§¦å‘
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸš€ Deploy to Production Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e  # ä»»ä½•å‘½ä»¤å¤±è´¥æ—¶ç«‹å³é€€å‡º

            echo "======================================"
            echo "ğŸš€ å¼€å§‹è‡ªåŠ¨éƒ¨ç½² Alia Web..."
            echo "======================================"

            # è¿›å…¥é¡¹ç›®ç›®å½•
            cd /var/www/alia

            # æ‹‰å–æœ€æ–°ä»£ç 
            echo "â¬‡ï¸  æ‹‰å–æœ€æ–°ä»£ç ..."
            git pull origin master || { echo "âŒ Git pull å¤±è´¥"; exit 1; }

            # å®‰è£…ä¾èµ–ï¼ˆä»…å®‰è£…æ–°å¢çš„ï¼‰
            echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
            npm install --production=false || { echo "âŒ npm install å¤±è´¥"; exit 1; }

            # æ„å»ºå‰ç«¯
            echo "ğŸ—ï¸  æ„å»ºå‰ç«¯..."
            chmod -R 755 node_modules/.bin
            npm run build || { echo "âŒ å‰ç«¯æ„å»ºå¤±è´¥ï¼æ£€æŸ¥æ˜¯å¦ç¼ºå°‘ä¾èµ–æˆ–è¯­æ³•é”™è¯¯"; exit 1; }

            # éªŒè¯æ„å»ºäº§ç‰©
            if [ ! -d "build" ] || [ -z "$(ls -A build)" ]; then
              echo "âŒ æ„å»ºç›®å½•ä¸ºç©ºæˆ–ä¸å­˜åœ¨"
              exit 1
            fi
            echo "âœ… æ„å»ºéªŒè¯é€šè¿‡"

            # é‡å¯åç«¯æœåŠ¡
            echo "ğŸ”„ é‡å¯åç«¯æœåŠ¡..."
            pm2 restart alia-server || { echo "âŒ PM2 é‡å¯å¤±è´¥"; exit 1; }

            # æ˜¾ç¤ºçŠ¶æ€
            echo ""
            echo "ğŸ“Š æœåŠ¡çŠ¶æ€ï¼š"
            pm2 status

            echo ""
            echo "======================================"
            echo "âœ… éƒ¨ç½²æˆåŠŸå®Œæˆï¼"
            echo "======================================"
            echo "ğŸŒ è®¿é—®åœ°å€: http://157.180.38.176"
            echo "â° éƒ¨ç½²æ—¶é—´: $(date)"
